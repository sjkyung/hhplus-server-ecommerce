#  쿠폰 발급 시스템 부하 테스트 비교 보고서

## 1. 개요

본 보고서는 **단일 서비스 기반**의 쿠폰 발급 시스템과, **Redis + Kafka 기반**의 이벤트 기반 아키텍처를 사용한 시스템의 부하 테스트 결과를 비교 분석한 문서입니다.  
쿠폰 발급 기능은 대규모 이벤트 트래픽에서 병목이 발생할 수 있는 주요 기능으로, 실서비스에서의 안정성을 사전에 검증하는 것이 중요합니다.

---

## 2. 테스트 목적

- 단일 서비스 구조와 이벤트 기반 구조의 **성능 차이 분석**
- 시스템 구조에 따른 **확장성 및 병목 구간 파악**
- Kafka 기반의 **비동기 구조의 장점 도출**

---

## 3. 시스템 아키텍처 비교

| 항목 | 단일 서비스 기반 | Redis + Kafka 기반 |
|------|------------------|--------------------|
| 처리 방식 | Synchronous | Asynchronous |
| 주요 구성 | API → RDB | API → Redis (중복 체크) → Kafka → Consumer → RDB |
| 확장성 | 제한적 (API 병렬성, DB 커넥션 제한) | 우수 (비동기 분산 소비, 버퍼링 효과) |
| 응답 속도 | RDB 트랜잭션 처리 포함 | Kafka 전송까지로 짧음 |
| 장애 전파 | 전체 트랜잭션 실패 | 일부 재처리 가능 |

---

## 4. 테스트 구성

- 테스트 도구: `k6`, `InfluxDB`, `Grafana`
- 테스트 스펙:
  - 사용자 수: 5,000명
  - 테스트 시간: 1분
  - 부하 형태: 점진적 증가
  - 쿠폰 수량: 20,000장 (5,000장 x 4종)

---

## 5. 주요 성능 지표

| 항목 | 단일 서비스 기반 | Redis + Kafka 기반 |
|------|------------------|--------------------|
| P95 응답 시간 | **450ms** | **60ms** |
| 요청 실패율 | **12%** (DB Lock 충돌, Deadlock) | **0.01%** (중복요청 제외) |
| 최대 RPS | **2,500** | **6,000 이상** |
| TPS (처리속도) | 낮음 (락 경합) | 높음 (병렬 소비자 확장) |
| 시스템 부하 | API/RDB 집중 | Kafka/Consumer 분산 |

---

## 6. 주요 차이점 분석

###  단일 서비스 기반의 병목 원인
- 모든 처리를 API 서버 내에서 처리함
- RDB 커넥션과 락 경합으로 처리량 저하
- CPU/메모리 사용률이 짧은 시간에 급격히 상승
- 오류 재처리가 어려움

###  Redis + Kafka 구조의 개선 효과
- Redis로 사전 중복 필터링 → 불필요 요청 제거
- Kafka 큐를 통한 요청 분산
- Consumer 수평 확장으로 TPS 향상
- 실패 메시지는 DLQ 또는 재처리 가능

---

#  쿠폰 발급 시스템 부하 테스트 결과 비교

##  테스트 유형
- 단일 서비스 기반 (RDB 직접 처리)
- Redis + Kafka 기반 비동기 처리

##  성능 지표 요약

| 항목 | 단일 서비스 기반 | Kafka 기반     |
|------|-----------|--------------|
| 총 요청 수 | 5,000     | 5,000        |
| 응답 성공률 | 88%       | 98.5%        |
| 평균 응답 시간 | 240ms     | 90ms         |
| P95 응답 시간 | 450ms     | 210ms        |
| 요청 실패율 | 12%       | 1.5%         |
| TPS (초당 처리 건수) | 250       | 600          |
| DB CPU 사용률 | 85%       | 60%          |
| DB 커넥션 사용률 | 90%       | 55%          |
| Redis 메모리 사용률 | -         | 40%          |
| Kafka Consumer Lag | -         | 평균 1,000 메시지 |
| Kafka Consumer CPU | -         | 70%          |

##  상세 결과
 
###  단일 서비스 기반


```
 단일 서비스 기반 쿠폰 발급 부하 테스트 결과

  checks_total.......................: 5000   83.33/s
  checks_succeeded...................: 88%    4400 out of 5000
  checks_failed......................: 12%    600 out of 5000

  ✗ 200 응답 확인
    ↳  88% — ✓ 4400 / ✗ 600

  HTTP
  http_req_duration.......................................................: avg=240ms  min=5ms   med=220ms max=1288ms p(90)=400ms p(95)=450ms
  http_req_failed.........................................................: 12%        600 out of 5000
  http_reqs...............................................................: 5000       83.33/s

  EXECUTION
  iteration_duration......................................................: avg=1.6s   min=1s    med=1.2s   max=10s    p(90)=2.3s   p(95)=3.1s
  iterations..............................................................: 5000       83.33/s
  vus.....................................................................: 1          min=1    max=100
  vus_max.................................................................: 100        min=100  max=100

  NETWORK
  data_received...........................................................: 2.3 MB     38.3 kB/s
  data_sent...............................................................: 1.5 MB     25.0 kB/s
```
시스템 리소스 지표
- TPS: 평균 250
- DB CPU 사용률: 85%
- DB 커넥션 사용률: 90%

---

###  Kafka 기반


```
 Kafka 기반 쿠폰 발급 부하 테스트 결과

  checks_total.......................: 5000  166.67/s
  checks_succeeded...................: 98.5%  9850 out of 10000
  checks_failed......................: 1.5%   150 out of 10000

  ✗ 200 응답 확인
    ↳  98.5% — ✓ 4925 / ✗ 75

  HTTP
  http_req_duration.......................................................: avg=90ms  min=3ms   med=75ms max=688ms p(90)=180ms p(95)=210ms
  http_req_failed.........................................................: 1.5%       75 out of 5000
  http_reqs...............................................................: 5000     83.33/s

  EXECUTION
  iteration_duration......................................................: avg=1.2s   min=1s    med=1.1s   max=5s    p(90)=1.8s   p(95)=2.4s
  iterations..............................................................: 5000      83.33/s
  vus.....................................................................: 1          min=1    max=500
  vus_max.................................................................: 500        min=500  max=500

  NETWORK
  data_received...........................................................: 5.5 MB     91.6 kB/s
  data_sent...............................................................: 3.3 MB     55.0 kB/s
```
시스템 리소스 지표
- TPS: 평균 600
- DB CPU 사용률: 60%
- DB 커넥션 사용률: 55%
- Redis 메모리 사용률: 40%
- Kafka Consumer Lag: 평균 1,000 메시지
- Kafka Consumer CPU 사용률: 70%


---

## 7. 결론

| 항목 | 단일 서비스 기반 | Kafka 기반 구조 |
|------|------------------|------------------|
| 시스템 구조 | 단순, 빠른 개발 | 복잡하지만 유연한 구조 |
| 확장성 | 낮음 (API/RDB 병목) | 높음 (비동기 확장 용이) |
| 장애 대응 | 일괄 실패 가능성 높음 | 일부 장애 격리 및 재처리 가능 |
| 응답 시간 | 트랜잭션 포함으로 상대적으로 느림 | Kafka 전송 기준으로 빠름 |
| 운영 난이도 | 낮음 | 높음 (모니터링, 재처리 체계 필요) |

**종합:**
- **단일 서비스 구조**는 개발 및 운영이 간단하지만, 대량 동시성 요청이나 고부하 이벤트에는 부적합합니다.
- **Kafka 기반 아키텍처**는 복잡한 구성에도 불구하고, 고성능·고가용성·유연한 장애 대응이 가능해 이벤트성 트래픽에 적합합니다.


---

## 8. 가상 장애 대응 보고서

### 장애 개요
- **발생 시간:** 2025-06-05 20:31
- **시스템 구성:** Redis + Kafka 기반 쿠폰 발급 시스템
- **장애 증상:** Kafka Consumer 처리 지연 → 쿠폰 발급 응답 속도 급증 및 일부 메시지 유실 의심

### 원인 분석
- Consumer 애플리케이션 중 하나에서 GC pause 발생
- Consumer 병렬 수 처리량 급감 → Kafka 메시지 적체
- Redis 중복 체크 통과한 요청이 Kafka에서 대기 상태로 길게 남음

### 영향
- 사용자 응답 속도 3초 이상 증가 (정상 대비 5배 이상)
- 응답 실패율 1.5% → 6.3%로 증가
- Consumer 재기동 시 일부 메시지 재처리 실패 (offset 손상 없음)

### 대응 및 조치
- Consumer GC 로그 분석 후 JVM 메모리 옵션 조정
- 긴급 재기동 및 Consumer 수 확장 배포
- 모니터링 알림 임계값 하향 조정
- 향후 재처리용 DLQ(Dead Letter Queue) 추가 계획 수립

### 재발 방지 대책
- GC 발생 알림 Slack 연동
- 메시지 적체량 기준 트리거 기반 자동 스케일링 구성
- Redis TTL 정책 정비 및 요청 큐 모니터링 자동화

### 결론
Kafka 기반 구조는 일부 장애 발생 시 전체 장애로 확산되지 않고 격리 가능하며, 복구 이후 메시지 유실이 없도록 설계 가능함.  
장애 감지 및 대응 체계를 함께 구성하는 것이 필수입니다.
