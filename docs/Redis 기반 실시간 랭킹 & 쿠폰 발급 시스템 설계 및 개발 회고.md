# Redis 기반 실시간 랭킹 & 비동기 쿠폰 발급 시스템 설계 및 개발 회고

## 1. 개요

본 프로젝트는 Redis를 활용한 두 가지 기능을 중심으로 설계 및 개발되었다.

- **실시간 랭킹 시스템**: 상품 판매량 기반의 일간·주간 인기 상품 랭킹을 Redis Sorted Set으로 구현
- **비동기 쿠폰 발급 시스템**: 사용자 요청 순서를 보장하며 중복을 방지하는 선착순 쿠폰 발급을 Redis List & Set으로 구현

---

## 2. 시스템 설계 개요

### 2.1. 실시간 랭킹 시스템

####  목적
- DB 부하 없이 실시간 집계된 인기 상품 Top-N을 빠르게 제공
- 조회 기준: 최근 3일(일간), 최근 1주일(주간) 동안의 판매량 누적

####  주요 설계
- Redis Sorted Set (`ZADD`, `ZINCRBY`) 기반 구조
- 키 전략:
  - 일간: `ranking:daily:{yyyyMMdd}`
  - 주간: `ranking:weekly:{yyyy-'W'ww}`

- 상품이 판매 완료될 때마다 이벤트를 발행하고, 이벤트 리스너가 해당 상품의 ID와 수량을 기반으로 두 키에 점수를 즉시 누적
상품 판매 수량은 재고 차감이 완료된 후, ProductSaleCompletedEvent를 발행하여
Redis Sorted Set에 ZINCRBY로 누적된다.
이는 주문 상태나 트랜잭션 완료 여부를 기반으로 하기 때문에 데이터의 신뢰성을 보장한다.

- 랭킹 조회 시 `ZREVRANGE`로 Top-N 추출 + DB에서 상품 정보 조합

####  스케줄러 역할
- 매일 새로운 일간 키 및 주간 키 TTL 설정만 수행

### 2.2. 비동기 쿠폰 발급 시스템

####  목적
- 사용자 요청 순서 보장
- 중복 신청 방지
- 응답 속도 최적화 (Redis로 선착순 처리, DB 저장은 비동기)

####  주요 설계

| 목적 | Redis 자료구조 | 키 |
|------|----------------|----|
| 순서 보장 | List | `coupon:stock` |
| 중복 방지 | Set | `coupon:applied` |
| 발급 대기 저장 | List | `coupon:issued:pending` |

- 발급 흐름:
  1. Set에 `userId`를 `SADD` → 중복 여부 확인
  2. List에서 `LPOP` → 쿠폰 재고 차감
  3. 성공 시 `userId:couponId` 형태로 pending List에 push

- 스케줄러가 `coupon:issued:pending`을 주기적(1초 마다 100건)으로 소비하여 DB(`UserCoupon`)에 저장

---

## 3. 회고

###  아쉬운 점 / 개선점

- Redis 큐를 무한 루프로 모두 처리하지 않고 `repeat(100)` 제한을 두었는데,  
  실제 운영 환경에서 트래픽 폭주 시 대기열이 누적되는 경우를 어떻게 처리할지에 대한 전략은 아직 부족함
- 랭킹 히스토리 또는 만료된 주간 키에 대한 백업 전략은 추후 필요할 수 있음

---

## 4. 결론

Redis의 다양한 자료구조 특성과 TTL 기능을 적절히 활용하여,
**실시간성과 안정성, 성능**을 모두 확보한 랭킹 & 쿠폰 발급 시스템을 구축할 수 있었다.

특히 이번 설계를 통해
- 이벤트 기반 처리
- Redis를 활용한 데이터 일관성 유지

단순한 구현을 넘어서 **운영 가능성 있는 시스템 설계**을 함께 고려할 수 있었다.
